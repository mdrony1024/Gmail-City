<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- All CSS styles are included here -->
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f4f7f6; margin: 0; padding: 2rem; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 900px; padding: 2rem; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .login-container { max-width: 400px; text-align: center; }
        h1, h2 { color: #333; }
        form { display: flex; flex-direction: column; gap: 1rem; }
        input { padding: 0.8rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 0.8rem 1.2rem; font-size: 1rem; border: none; border-radius: 4px; color: white; cursor: pointer; transition: background-color 0.2s; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 1rem; margin-bottom: 1rem; }
        .header button { background: #e74c3c; }
        .header button:hover { background: #c0392b; }
        .error { color: #e74c3c; margin-top: 1rem; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.8rem; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f2f2f2; }
        .actions button { margin-right: 0.5rem; }
        .approve { background: #2ecc71; }
        .approve:hover { background: #27ae60; }
        .reject { background: #e74c3c; }
        .reject:hover { background: #c0392b; }
        #loader { text-align: center; font-size: 1.2rem; color: #555; }
        .submit-btn { background-color: #3498db; }
        .submit-btn:hover { background-color: #2980b9; }
    </style>
</head>
<body>

    <!-- The entire application will be rendered inside this div -->
    <div id="root">
        <!-- Initially, it shows a loading message -->
        <div id="loader">Loading Admin Panel...</div>
    </div>

    <!-- Firebase SDKs (required for Firebase to work in the browser) -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

    <!-- All JavaScript logic is included here -->
    <script>
        // =========================================================================================
        // IMPORTANT: This script combines all React components (App.js, LoginPage.js, AdminPanel.js)
        // into a single vanilla JavaScript file for demonstration purposes.
        // =========================================================================================

        // --- 1. FIREBASE CONFIGURATION (like firebaseConfig.js) ---
        // TODO: Replace with your actual Firebase project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC5xPkPtV6q3U23YkH6bITxPI_VtWgUpd8",
            authDomain: "detpocket.firebaseapp.com",
            projectId: "detpocket",
            storageBucket: "detpocket.appspot.com",
            messagingSenderId: "444858729583",
            appId: "1:444858729583:web:df636569ac56388ee0b99a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rootElement = document.getElementById('root');

        // --- 2. TEMPLATES (HTML content generated by JavaScript) ---

        function getLoginPageHTML() {
            return `
                <div class="container login-container">
                    <h2>Admin Panel Login</h2>
                    <form id="login-form">
                        <input type="email" id="email" placeholder="Email" required />
                        <input type="password" id="password" placeholder="Password" required />
                        <button type="submit" class="submit-btn">Login</button>
                        <p id="error-message" class="error"></p>
                    </form>
                </div>
            `;
        }

        function getAdminPanelHTML(pendingGmails = []) {
            let tableRows = pendingGmails.map(gmail => `
                <tr data-id="${gmail.id}">
                    <td>${gmail.gmailAddress}</td>
                    <td>${gmail.submittedBy}</td>
                    <td class="actions">
                        <button class="approve" onclick="handleAction('${gmail.id}', '${gmail.submittedBy}', 'approved')">Approve</button>
                        <button class="reject" onclick="handleAction('${gmail.id}', '${gmail.submittedBy}', 'rejected')">Reject</button>
                    </td>
                </tr>
            `).join('');

            if (pendingGmails.length === 0) {
                tableRows = `<tr><td colSpan="3">No pending submissions.</td></tr>`;
            }

            return `
                <div class="container">
                    <div class="header">
                        <h1>Admin Dashboard</h1>
                        <button id="logout-btn">Logout</button>
                    </div>
                    <h2>Pending Submissions</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Gmail Address</th>
                                <th>Submitted By (User ID)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // --- 3. LOGIC (Functions to handle events and data) ---

        // Function to render the Admin Panel
        async function renderAdminPanel() {
            rootElement.innerHTML = '<div id="loader">Loading submissions...</div>';
            try {
                const q = db.collection('gmails').where('status', '==', 'pending');
                const snapshot = await q.get();
                const gmails = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                rootElement.innerHTML = getAdminPanelHTML(gmails);
                // Attach logout event listener
                document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
            } catch (error) {
                console.error("Error fetching gmails:", error);
                rootElement.innerHTML = `<p class="error">Failed to load data.</p>`;
            }
        }

        // Function to render the Login Page
        function renderLoginPage() {
            rootElement.innerHTML = getLoginPageHTML();
            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = '';

                try {
                    const adminsDoc = await db.collection('settings').doc('admins').get();
                    if (!adminsDoc.exists() || !adminsDoc.data().adminEmails.includes(email)) {
                        return errorMessage.textContent = 'Access Denied: This email is not authorized.';
                    }
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    errorMessage.textContent = 'Failed to login. Check credentials.';
                    console.error(err);
                }
            });
        }
        
        // Function to handle Approve/Reject actions
        async function handleAction(gmailId, submittedBy, newStatus) {
            const row = document.querySelector(`tr[data-id="${gmailId}"]`);
            row.style.opacity = '0.5'; // Visually indicate processing
            
            const transaction = db.runTransaction(async (t) => {
                const gmailRef = db.collection('gmails').doc(gmailId);
                const userRef = db.collection('users').doc(submittedBy);
                const settingsRef = db.collection('settings').doc('config');
                
                const settingsDoc = await t.get(settingsRef);
                const userDoc = await t.get(userRef);

                if (!settingsDoc.exists() || !userDoc.exists()) throw new Error("Missing data");

                if (newStatus === 'approved') {
                    const { defaultGmailPrice, referralCommissionRate } = settingsDoc.data();
                    const price = defaultGmailPrice;
                    t.update(userRef, {
                        balance: firebase.firestore.FieldValue.increment(price),
                        approvedCount: firebase.firestore.FieldValue.increment(1)
                    });
                    const referrerId = userDoc.data().referredBy;
                    if (referrerId) {
                        const commission = price * (referralCommissionRate / 100);
                        const referrerRef = db.collection('users').doc(referrerId);
                        t.update(referrerRef, { balance: firebase.firestore.FieldValue.increment(commission) });
                    }
                } else if (newStatus === 'rejected') {
                    t.update(userRef, { rejectedCount: firebase.firestore.FieldValue.increment(1) });
                }
                
                t.update(gmailRef, { status: newStatus });
            });

            try {
                await transaction;
                row.remove(); // Remove from UI on success
            } catch (e) {
                alert("Transaction failed: " + e.message);
                row.style.opacity = '1'; // Revert visual state on failure
            }
        }


        // --- 4. MAIN APPLICATION FLOW (like App.js) ---
        auth.onAuthStateChanged(user => {
            if (user) {
                // If user is logged in, show the admin panel
                renderAdminPanel();
            } else {
                // If user is not logged in, show the login page
                renderLoginPage();
            }
        });

    </script>
</body>
  </html>
